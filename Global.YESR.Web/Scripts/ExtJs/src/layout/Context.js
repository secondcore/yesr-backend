Ext.define("Ext.layout.Context",{requires:["Ext.util.Queue","Ext.layout.ContextItem","Ext.layout.Layout","Ext.fx.Anim","Ext.fx.Manager"],currentOwnerCtContext:null,remainingLayouts:0,state:0,constructor:function(a){var b=this;Ext.apply(b,a);b.items={};b.layouts={};b.blockCount=0;b.cycleCount=0;b.flushCount=0;b.calcCount=0;b.animateQueue=b.newQueue();b.completionQueue=b.newQueue();b.finalizeQueue=b.newQueue();b.finishQueue=b.newQueue();b.flushQueue=b.newQueue();b.invalidateData={};b.layoutQueue=b.newQueue();b.invalidQueue=[];b.triggers={data:{},dom:{}}},callLayout:function(b,a){this.currentLayout=b;var c=this.getCmp(b.owner);b[a](c)},cancelComponent:function(g,a){var m=this,f=g,h=!g.isComponent,b=h?f.length:1,d,c,l,j,e,p,n,o,q;for(d=0;d<b;++d){if(h){g=f[d]}if(!a){n=m.invalidQueue;l=n.length;if(l){m.invalidQueue=p=[];for(c=0;c<l;++c){o=n[c];q=o.item.target;if(q!=g&&!q.isDescendant(g)){p.push(o)}}}}e=g.componentLayout;m.cancelLayout(e);if(e.getLayoutItems){j=e.getLayoutItems();if(j.length){m.cancelComponent(j,true)}}if(g.isContainer&&!g.collapsed){e=g.layout;m.cancelLayout(e);j=e.getVisibleItems();if(j.length){m.cancelComponent(j,true)}}}},cancelLayout:function(b){var a=this;a.completionQueue.remove(b);a.finalizeQueue.remove(b);a.finishQueue.remove(b);a.layoutQueue.remove(b);if(b.running){a.layoutDone(b)}b.ownerContext=null},clearTriggers:function(f,g){var a=f.id,h=this.triggers[g?"dom":"data"][a],b=(h&&h.length)||0,e,d,j,c;for(d=0;d<b;++d){c=h[d];j=c.item;e=g?j.domTriggers:j.triggers;delete e[c.prop][a]}},finishInvalidate:function(b,e,a){if(b[a]){var d=this,c=d.currentLayout;d.currentLayout=b.layout||null;b[a](e,b);d.currentLayout=c}},flush:function(){var d=this,a=d.flushQueue.clear(),c=a.length,b;if(c){++d.flushCount;for(b=0;b<c;++b){a[b].flush()}}},flushAnimations:function(){var d=this,b=d.animateQueue.clear(),a=b.length,c;if(a){for(c=0;c<a;c++){if(b[c].target.animate!==false){b[c].flushAnimations()}}Ext.fx.Manager.runner()}},flushInvalidates:function(){var g=this,a=g.invalidQueue,f=a&&a.length,b,e,d,c;g.invalidQueue=[];if(f){e=[];for(c=0;c<f;++c){b=(d=a[c]).item.target;if(!b.container.isDetachedBody){e.push(b);if(d.options){g.invalidateData[b.id]=d.options}}}g.invalidate(e,null)}},flushLayouts:function(g,a,c){var f=this,h=c?f[g].items:f[g].clear(),e=h.length,b,d;if(e){for(b=0;b<e;++b){d=h[b];if(!d.running){f.callLayout(d,a)}}f.currentLayout=null}},getCmp:function(a){return this.getItem(a,a.el)},getEl:function(b,a){var c=this.getItem(a,a);if(!c.parent){c.parent=b;if(b.children.length){b.children.push(c)}else{b.children=[c]}}return c},getItem:function(d,b){var e=b.id,a=this.items,c=a[e]||(a[e]=new Ext.layout.ContextItem({context:this,target:d,el:b,ownerCtContext:this.currentOwnerCtContext}));return c},handleFailure:function(){var c=this.layouts,b,a;Ext.failedLayouts=(Ext.failedLayouts||0)+1;Ext.log("Layout run failed");for(a in c){b=c[a];if(c.hasOwnProperty(a)){b.running=false;b.ownerContext=null}}},invalidate:function(n,p,l){var y=this,m=!n.isComponent,a=y.items,b=y.state>0,q=y.currentOwnerCtContext,g,u,e,t,j,s,r,x,w,o,f,d,v,c,h;y.currentOwnerCtContext=p;for(s=0,f=m?n.length:1;s<f;++s){x=m?n[s]:n;if(x.rendered&&!x.hidden){j=!x.componentLayout.ownerContext;w=y.getCmp(x);if(j){if(x.beforeLayout){x.beforeLayout()}if(b&&!p&&(t=x.ownerCt)){p=a[t.el.id]}w.init(p)}g=u=e=true;d=x.componentLayout;d.ownerContext=w;if(d.getLayoutItems){d.renderChildren();o=d.getLayoutItems();if(o.length){y.invalidate(o,w,true);g=false}}if(x.isContainer&&!x.collapsed){v=x.layout;v.ownerContext=w;v.renderChildren();e=false;o=v.getVisibleItems();if(o.length){y.invalidate(o,w,true);u=false}}else{v=null}if(j){w.hasRawContent=true;if(w.target.isContainer){if(w.target.items.items.length||!w.target.getTargetEl().dom.firstChild){w.hasRawContent=false}}}else{w.doInvalidate(l);o=w.children;for(r=o.length;r--;){o[r].doInvalidate(true)}}c=w.props;if(g){c.componentChildrenDone=true;if(u){c.childrenDone=true}}if(u){c.containerChildrenDone=true}if(e){c.containerLayoutDone=true}h=y.invalidateData[w.id];if(h){delete y.invalidateData[w.id];if(h.state){Ext.apply(w.state,h.state)}y.finishInvalidate(h,w,"before")}y.resetLayout(d,w,j);if(v){y.resetLayout(v,w,j)}if(h){y.finishInvalidate(h,w,"after")}if(w.boxChildren&&w.widthModel.shrinkWrap){w.el.setWidth(10000);w.state.blocks=(w.state.blocks||0)+1}if(j){w.initAnimatePolicy()}}}y.currentOwnerCtContext=q},layoutDone:function(b){var c=b.ownerContext,a;b.running=false;if(b.isComponentLayout){if(c.measuresBox){c.onBoxMeasured()}c.setProp("done",true);a=c.ownerCtContext;if(a){if(c.target.ownerLayout.isComponentLayout){if(!--a.remainingComponentChildLayouts){a.setProp("componentChildrenDone",true)}}else{if(!--a.remainingContainerChildLayouts){a.setProp("containerChildrenDone",true)}}if(!--a.remainingChildLayouts){a.setProp("childrenDone",true)}}}else{c.setProp("containerLayoutDone",true)}--this.remainingLayouts;++this.progressCount},newQueue:function(){return new Ext.util.Queue()},queueAnimation:function(a){this.animateQueue.add(a)},queueCompletion:function(a){this.completionQueue.add(a)},queueFinalize:function(a){this.finalizeQueue.add(a)},queueFlush:function(a){this.flushQueue.add(a)},chainFns:function(a,e,c){var b=a[c],d=e[c];return function(f){if(b){b.call(a.scope||a,f,a)}d.call(e.scope||e,f,e)}},queueInvalidate:function(j,k){var g=this,i=[],h=g.invalidQueue,f=h.length,d,b,e,a,c;if(j.isComponent){j=g.getCmp(d=j)}else{d=j.target}while(f--){b=h[f];e=b.item.target;if(d.isDescendant(e)){return}if(e==d){if(!(a=b.options)){b.options=k}else{if(k){if(!(c=a.state)){a.state=k.state}else{if(k.state){Ext.apply(c,k.state)}}if(k.before){a.before=g.chainFns(a,k,"before")}if(k.after){a.after=g.chainFns(a,k,"after")}}}return}if(!e.isDescendant(d)){i.push(b)}}i.push({item:j,options:k});g.invalidQueue=i},queueItemLayouts:function(c){var a=c.isComponent?c:c.target,b=a.componentLayout;if(!b.pending&&!b.invalid&&!b.done){this.queueLayout(b)}b=a.layout;if(b&&!b.pending&&!b.invalid&&!b.done){this.queueLayout(b)}},queueLayout:function(a){this.layoutQueue.add(a);a.pending=true},resetLayout:function(c,d,e){var b=this,a;b.currentLayout=c;c.done=false;c.pending=true;c.firedTriggers=0;b.layoutQueue.add(c);if(e){b.layouts[c.id]=c;c.running=true;if(c.finishedLayout){b.finishQueue.add(c)}++b.remainingLayouts;++c.layoutCount;c.beginCount=0;c.blockCount=0;c.calcCount=0;c.triggerCount=0;if(c.isComponentLayout&&(a=d.ownerCtContext)){if(d.target.ownerLayout.isComponentLayout){++a.remainingComponentChildLayouts}else{++a.remainingContainerChildLayouts}++a.remainingChildLayouts}if(!c.initialized){c.initLayout()}c.beginLayout(d)}else{++c.beginCount;if(!c.running){++b.remainingLayouts;c.running=true;if(c.isComponentLayout){d.unsetProp("done");a=d.ownerCtContext;if(a){if(d.target.ownerLayout.isComponentLayout){if(++a.remainingComponentChildLayouts==1){a.unsetProp("componentChildrenDone")}}else{if(++a.remainingContainerChildLayouts==1){a.unsetProp("containerChildrenDone")}}if(++a.remainingChildLayouts==1){a.unsetProp("childrenDone")}}}b.completionQueue.remove(c);b.finalizeQueue.remove(c)}}c.beginLayoutCycle(d,e)},run:function(){var c=this,b=false,a=100;c.flushInvalidates();c.state=1;c.totalCount=c.layoutQueue.getCount();c.flush();while((c.remainingLayouts||c.invalidQueue.length)&&a--){if(c.invalidQueue.length){c.flushInvalidates()}if(c.runCycle()){b=false}else{if(!b){c.flush();b=true;c.flushLayouts("completionQueue","completeLayout")}else{c.state=2;break}}if(!(c.remainingLayouts||c.invalidQueue.length)){c.flush();c.flushLayouts("completionQueue","completeLayout");c.flushLayouts("finalizeQueue","finalizeLayout")}}return c.runComplete()},runComplete:function(){var a=this;a.state=2;if(a.remainingLayouts){a.handleFailure();return false}a.flush();a.flushLayouts("finishQueue","finishedLayout",true);a.flushLayouts("finishQueue","notifyOwner");a.flush();a.flushAnimations();return true},runCycle:function(){var c=this,d=c.layoutQueue.clear(),b=d.length,a;++c.cycleCount;c.progressCount=0;for(a=0;a<b;++a){c.runLayout(c.currentLayout=d[a])}c.currentLayout=null;return c.progressCount>0},runLayout:function(b){var a=this,c=a.getCmp(b.owner);b.pending=false;if(c.state.blocks){return}b.done=true;++b.calcCount;++a.calcCount;b.calculate(c);if(b.done){a.layoutDone(b);if(b.completeLayout){a.queueCompletion(b)}if(b.finalizeLayout){a.queueFinalize(b)}}else{if(!b.pending&&!b.invalid&&!(b.blockCount+b.triggerCount-b.firedTriggers)){a.queueLayout(b)}}},setItemSize:function(g,f,b){var d=g,a=1,c,e;if(g.isComposite){d=g.elements;a=d.length;g=d[0]}else{if(!g.dom&&!g.el){a=d.length;g=d[0]}}for(e=0;e<a;){c=this.get(g);c.setSize(f,b);g=d[++e]}}});