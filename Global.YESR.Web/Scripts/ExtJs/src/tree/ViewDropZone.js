Ext.define("Ext.tree.ViewDropZone",{extend:"Ext.view.DropZone",allowParentInserts:false,allowContainerDrops:false,appendOnly:false,expandDelay:500,indicatorCls:Ext.baseCSSPrefix+"tree-ddindicator",expandNode:function(b){var a=this.view;if(!b.isLeaf()&&!b.isExpanded()){a.expand(b);this.expandProcId=false}},queueExpand:function(a){this.expandProcId=Ext.Function.defer(this.expandNode,this.expandDelay,this,[a])},cancelExpand:function(){if(this.expandProcId){clearTimeout(this.expandProcId);this.expandProcId=false}},getPosition:function(f,b){var i=this.view,c=i.getRecord(b),g=f.getPageY(),j=c.isLeaf(),a=false,h=Ext.fly(b).getRegion(),d;if(c.isRoot()){return"append"}if(this.appendOnly){return j?false:"append"}if(!this.allowParentInsert){a=c.hasChildNodes()&&c.isExpanded()}d=(h.bottom-h.top)/(j?2:3);if(g>=h.top&&g<(h.top+d)){return"before"}else{if(!a&&(j||(g>=(h.bottom-d)&&g<=h.bottom))){return"after"}else{return"append"}}},isValidDropPoint:function(b,h,m,j,f){if(!b||!f.item){return false}var n=this.view,k=n.getRecord(b),d=f.records,a=d.length,l=d.length,c,g;if(!(k&&h&&a)){return false}for(c=0;c<l;c++){g=d[c];if(g.isNode&&g.contains(k)){return false}}if(h==="append"&&k.get("allowDrop")===false){return false}else{if(h!="append"&&k.parentNode.get("allowDrop")===false){return false}}if(Ext.Array.contains(d,k)){return false}return true},onNodeOver:function(a,h,f,c){var d=this.getPosition(f,a),b=this.dropNotAllowed,i=this.view,g=i.getRecord(a),j=this.getIndicator(),l=0,k=0;this.cancelExpand();if(d=="append"&&!this.expandProcId&&!Ext.Array.contains(c.records,g)&&!g.isLeaf()&&!g.isExpanded()){this.queueExpand(g)}if(this.isValidDropPoint(a,d,h,f,c)){this.valid=true;this.currentPosition=d;this.overRecord=g;j.setWidth(Ext.fly(a).getWidth());k=Ext.fly(a).getY()-Ext.fly(i.el).getY()-1;if(d=="before"){b=g.isFirst()?Ext.baseCSSPrefix+"tree-drop-ok-above":Ext.baseCSSPrefix+"tree-drop-ok-between";j.showAt(0,k);h.proxy.show()}else{if(d=="after"){b=g.isLast()?Ext.baseCSSPrefix+"tree-drop-ok-below":Ext.baseCSSPrefix+"tree-drop-ok-between";k+=Ext.fly(a).getHeight();j.showAt(0,k);h.proxy.show()}else{b=Ext.baseCSSPrefix+"tree-drop-ok-append";j.hide()}}}else{this.valid=false}this.currentCls=b;return b},onContainerOver:function(a,c,b){return c.getTarget("."+this.indicatorCls)?this.currentCls:this.dropNotAllowed},notifyOut:function(){this.callParent(arguments);this.cancelExpand()},handleNodeDrop:function(d,k,e){var m=this,n=m.view,f=k.parentNode,o=n.getStore(),q=[],a,c,j,b,h,l,p,g;if(d.copy){a=d.records;d.records=[];for(c=0,j=a.length;c<j;c++){d.records.push(Ext.apply({},a[c].data))}}m.cancelExpand();if(e=="before"){b=f.insertBefore;h=[null,k];k=f}else{if(e=="after"){if(k.nextSibling){b=f.insertBefore;h=[null,k.nextSibling]}else{b=f.appendChild;h=[null]}k=f}else{if(!k.isExpanded()){l=true}b=k.appendChild;h=[null]}}p=function(){var u,t,s,i,v;for(c=0,j=d.records.length;c<j;c++){h[0]=d.records[c];u=b.apply(k,h);if(Ext.enableFx&&m.dropHighlight){q.push(n.getNode(u))}}if(Ext.enableFx&&m.dropHighlight){s=q.length;i=m.dropHighlightColor;for(t=0;t<s;t++){v=q[t];if(v){Ext.fly(v.firstChild?v.firstChild:v).highlight(i)}}}};if(l){k.expand(false,p)}else{p()}}});