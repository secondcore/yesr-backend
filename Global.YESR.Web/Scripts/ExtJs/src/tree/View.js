Ext.define("Ext.tree.View",{extend:"Ext.view.Table",alias:"widget.treeview",requires:["Ext.data.NodeStore"],loadingCls:Ext.baseCSSPrefix+"grid-tree-loading",expandedCls:Ext.baseCSSPrefix+"grid-tree-node-expanded",leafCls:Ext.baseCSSPrefix+"grid-tree-node-leaf",expanderSelector:"."+Ext.baseCSSPrefix+"tree-expander",checkboxSelector:"."+Ext.baseCSSPrefix+"tree-checkbox",expanderIconOverCls:Ext.baseCSSPrefix+"tree-expander-over",nodeAnimWrapCls:Ext.baseCSSPrefix+"tree-animator-wrap",blockRefresh:true,rootVisible:true,deferInitialRefresh:false,expandDuration:250,collapseDuration:250,toggleOnDblClick:true,stripeRows:false,uiFields:["expanded","loaded","checked","expandable","leaf","icon","iconCls","loading"],initComponent:function(){var a=this,b=a.panel.getStore();if(a.initialConfig.animate===undefined){a.animate=Ext.enableFx}a.store=new Ext.data.NodeStore({treeStore:b,recursive:true,rootVisible:a.rootVisible,listeners:{beforeexpand:a.onBeforeExpand,expand:a.onExpand,beforecollapse:a.onBeforeCollapse,collapse:a.onCollapse,write:a.onStoreWrite,datachanged:a.onStoreDataChanged,scope:a}});if(a.node){a.setRootNode(a.node)}a.animQueue={};a.animWraps={};a.addEvents("afteritemexpand","afteritemcollapse");a.callParent(arguments);a.on({element:"el",scope:a,delegate:a.expanderSelector,mouseover:a.onExpanderMouseOver,mouseout:a.onExpanderMouseOut});a.on({element:"el",scope:a,delegate:a.checkboxSelector,click:a.onCheckboxChange})},afterComponentLayout:function(){this.callParent(arguments);var a=this.stretcher;if(a){a.setWidth((this.getWidth()-Ext.getScrollbarSize().width))}},processUIEvent:function(a){if(a.getTarget("."+this.nodeAnimWrapCls,this.el)){return false}return this.callParent(arguments)},onClear:function(){this.store.removeAll()},setRootNode:function(b){var a=this;a.store.setNode(b);a.node=b},onCheckboxChange:function(d,a){var c=this,b=d.getTarget(c.getItemSelector(),c.getTargetEl());if(b){c.onCheckChange(c.getRecord(b))}},onCheckChange:function(a){var b=a.get("checked");if(Ext.isBoolean(b)){b=!b;a.set("checked",b);this.fireEvent("checkchange",a,b)}},getChecked:function(){var a=[];this.node.cascadeBy(function(b){if(b.get("checked")){a.push(b)}});return a},isItemChecked:function(a){return a.get("checked")},createAnimWrap:function(h,j){var f="",e=this.panel.headerCt,b=e.getGridColumns(),g=0,k=b.length,l,d=this.getNode(h),a,c;for(;g<k;g++){l=b[g];f+='<th style="width: '+(l.hidden?0:l.getDesiredWidth())+'px; height: 0px;"></th>'}c=Ext.get(d);a=c.insertSibling({tag:"tr",html:['<td colspan="'+e.getColumnCount()+'">','<div class="'+this.nodeAnimWrapCls+'">','<table class="'+Ext.baseCSSPrefix+'grid-table" style="width: '+e.getFullWidth()+'px;"><tbody>',f,"</tbody></table>","</div>","</td>"].join("")},"after");return{record:h,node:d,el:a,expanding:false,collapsing:false,animating:false,animateEl:a.down("div"),targetEl:a.down("tbody")}},getAnimWrap:function(d,a){if(!this.animate){return null}var b=this.animWraps,c=b[d.internalId];if(a!==false){while(!c&&d){d=d.parentNode;if(d){c=b[d.internalId]}}}return c},doAdd:function(b,d,h){var i=this,f=d[0],k=f.parentNode,j=i.all.elements,m=0,e=i.getAnimWrap(k),l,c,g;if(!e||!e.expanding){return i.callParent(arguments)}k=e.record;l=e.targetEl;c=l.dom.childNodes;g=c.length-1;m=h-i.indexOf(k)-1;if(!g||m>=g){l.appendChild(b)}else{Ext.fly(c[m+1]).insertSibling(b,"before",true)}Ext.Array.insert(j,h,b);if(e.isAnimating){i.onExpand(k)}},beginBulkUpdate:function(){this.bulkUpdate=true;this.ownerCt.changingScrollbars=true},endBulkUpdate:function(){this.bulkUpdate=false;this.ownerCt.changingScrollbars=true},onRemove:function(e,a,b){var d=this,c=d.bulkUpdate;if(d.rendered){d.doRemove(a,b);if(!c){d.updateIndexes(b)}if(d.store.getCount()===0){d.refresh()}if(!c){d.fireEvent("itemremove",a,b)}}},doRemove:function(a,c){var f=this,d=f.all,b=f.getAnimWrap(a),e=d.item(c).dom;if(!b||!b.collapsing){return f.callParent(arguments)}b.targetEl.appendChild(e);d.removeElement(c)},onBeforeExpand:function(d,b,c){var e=this,a;if(!e.rendered||!e.animate){return}if(e.getNode(d)){a=e.getAnimWrap(d,false);if(!a){a=e.animWraps[d.internalId]=e.createAnimWrap(d);a.animateEl.setHeight(0)}else{if(a.collapsing){a.targetEl.select(e.itemSelector).remove()}}a.expanding=true;a.collapsing=false}},onExpand:function(h){var g=this,e=g.animQueue,a=h.getId(),c=g.getNode(h),f=c?g.indexOf(c):-1,d,b,i;if(g.singleExpand){g.ensureSingleExpand(h)}if(f===-1){return}d=g.getAnimWrap(h,false);if(!d){g.isExpandingOrCollapsing=false;g.fireEvent("afteritemexpand",h,f,c);return}b=d.animateEl;i=d.targetEl;b.stopAnimation();e[a]=true;b.slideIn("t",{duration:g.expandDuration,listeners:{scope:g,lastframe:function(){d.el.insertSibling(i.query(g.itemSelector),"before");d.el.remove();delete g.animWraps[d.record.internalId];delete e[a]}},callback:function(){g.isExpandingOrCollapsing=false;g.fireEvent("afteritemexpand",h,f,c)}});d.isAnimating=true},onBeforeCollapse:function(d,b,c){var e=this,a;if(!e.rendered||!e.animate){return}if(e.getNode(d)){a=e.getAnimWrap(d);if(!a){a=e.animWraps[d.internalId]=e.createAnimWrap(d,c)}else{if(a.expanding){a.targetEl.select(this.itemSelector).remove()}}a.expanding=false;a.collapsing=true}},onCollapse:function(h){var g=this,e=g.animQueue,a=h.getId(),c=g.getNode(h),f=c?g.indexOf(c):-1,d=g.getAnimWrap(h),b,i;if(f===-1){return}if(!d){g.isExpandingOrCollapsing=false;g.fireEvent("afteritemcollapse",h,f,c);return}b=d.animateEl;i=d.targetEl;e[a]=true;b.stopAnimation();b.slideOut("t",{duration:g.collapseDuration,listeners:{scope:g,lastframe:function(){d.el.remove();delete g.animWraps[d.record.internalId];delete e[a]}},callback:function(){g.isExpandingOrCollapsing=false;g.fireEvent("afteritemcollapse",h,f,c)}});d.isAnimating=true},isAnimating:function(a){return !!this.animQueue[a.getId()]},collectData:function(c){var f=this.callParent(arguments),e=f.rows,a=e.length,d=0,g,b;for(;d<a;d++){g=e[d];b=c[d];if(b.get("qtip")){g.rowAttr='data-qtip="'+b.get("qtip")+'"';if(b.get("qtitle")){g.rowAttr+=' data-qtitle="'+b.get("qtitle")+'"'}}if(b.isExpanded()){g.rowCls=(g.rowCls||"")+" "+this.expandedCls}if(b.isLeaf()){g.rowCls=(g.rowCls||"")+" "+this.leafCls}if(b.isLoading()){g.rowCls=(g.rowCls||"")+" "+this.loadingCls}}return f},expand:function(b,a,d,c){return b.expand(a,d,c)},collapse:function(b,a,d,c){return b.collapse(a,d,c)},toggle:function(c,b,f,d){var e=this,a=!!this.animate;if(!a||!this.isExpandingOrCollapsing){if(!c.isLeaf()){this.isExpandingOrCollapsing=a}if(c.isExpanded()){e.collapse(c,b,f,d)}else{e.expand(c,b,f,d)}}},onItemDblClick:function(a,d,c){var b=this.editingPlugin;this.callParent(arguments);if(this.toggleOnDblClick&&!(b&&b.clicksToEdit===2)){this.toggle(a)}},onBeforeItemMouseDown:function(a,c,b,d){if(d.getTarget(this.expanderSelector,c)){return false}return this.callParent(arguments)},onItemClick:function(a,c,b,d){if(d.getTarget(this.expanderSelector,c)){this.toggle(a,d.ctrlKey);return false}return this.callParent(arguments)},onExpanderMouseOver:function(b,a){b.getTarget(this.cellSelector,10,true).addCls(this.expanderIconOverCls)},onExpanderMouseOut:function(b,a){b.getTarget(this.cellSelector,10,true).removeCls(this.expanderIconOverCls)},getTreeStore:function(){return this.panel.store},ensureSingleExpand:function(b){var a=b.parentNode;if(a){a.eachChild(function(c){if(c!==b&&c.isExpanded()){c.collapse()}})}},shouldUpdateCell:function(b,a){return Ext.Array.contains(this.uiFields,b.dataIndex)||this.callParent(arguments)},onStoreWrite:function(b,a){var c=this.panel.store;c.fireEvent("write",c,a)},onStoreDataChanged:function(b,a){var c=this.panel.store;c.fireEvent("datachanged",c)}});