Ext.define("Ext.grid.Lockable",{requires:["Ext.grid.LockingView","Ext.view.Table"],syncRowHeight:true,headerCounter:0,scrollDelta:40,unlockText:"Unlock",lockText:"Lock",determineXTypeToCreate:function(){var c=this,f,d,b,e,a;if(c.subGridXType){f=c.subGridXType}else{d=this.getXTypes().split("/");b=d.length;e=d[b-1];a=d[b-2];if(a!=="tablepanel"){f=a}else{f=e}}return f},injectLockable:function(){this.lockable=true;this.hasView=true;var p=this,k=Ext.getScrollbarSize().width===0,q=p.store=Ext.StoreManager.lookup(p.store),a=p.determineXTypeToCreate(),l=p.getSelectionModel(),j=p.prepareFeatures(),f=p.prepareFeatures(),d,n,g=0,m,c,b,h,r,e,o;for(g=0,m=(j?j.length:0);g<m;g++){j[g].lockingPartner=f[g];f[g].lockingPartner=j[g]}d=Ext.apply({xtype:a,store:q,scrollerOwner:false,enableAnimations:false,scroll:k?"vertical":false,selModel:l,border:false,cls:Ext.baseCSSPrefix+"grid-inner-locked",isLayoutRoot:function(){return false},features:j},p.lockedGridConfig);n=Ext.apply({xtype:a,store:q,scrollerOwner:false,enableAnimations:false,selModel:l,border:false,isLayoutRoot:function(){return false},features:f},p.normalGridConfig);p.addCls(Ext.baseCSSPrefix+"grid-locked");Ext.copyTo(n,p,p.bothCfgCopy);Ext.copyTo(d,p,p.bothCfgCopy);Ext.copyTo(n,p,p.normalCfgCopy);Ext.copyTo(d,p,p.lockedCfgCopy);for(g=0;g<p.normalCfgCopy.length;g++){delete p[p.normalCfgCopy[g]]}for(g=0;g<p.lockedCfgCopy.length;g++){delete p[p.lockedCfgCopy[g]]}p.addEvents("lockcolumn","unlockcolumn");p.addStateEvents(["lockcolumn","unlockcolumn"]);p.lockedHeights=[];p.normalHeights=[];c=p.processColumns(p.columns);d.width=c.lockedWidth+Ext.num(l.headerWidth,0);d.columns=c.locked;n.columns=c.normal;n.flex=1;d.viewConfig=p.lockedViewConfig||{};d.viewConfig.loadingUseMsg=false;n.viewConfig=p.normalViewConfig||{};Ext.applyIf(d.viewConfig,p.viewConfig);Ext.applyIf(n.viewConfig,p.viewConfig);p.normalGrid=Ext.ComponentManager.create(n);p.lockedGrid=Ext.ComponentManager.create(d);p.view=new Ext.grid.LockingView({locked:p.lockedGrid,normal:p.normalGrid,panel:p});r=p.lockedGrid.getView();e=p.normalGrid.getView();if(k){o={scroll:{fn:p.onLockedViewScroll,element:"el",scope:p}}}else{o={mousewheel:{fn:p.onLockedViewMouseWheel,element:"el",scope:p}}}if(p.syncRowHeight){o.refresh=p.onLockedViewRefresh;o.itemupdate=p.onLockedViewItemUpdate;o.scope=p}r.on(o);o={scroll:{fn:p.onNormalViewScroll,element:"el",scope:p},refresh:p.syncRowHeight?p.onNormalViewRefresh:p.updateSpacer,scope:p};e.on(o);b=p.lockedGrid.headerCt;h=p.normalGrid.headerCt;b.lockedCt=true;b.lockableInjected=true;h.lockableInjected=true;b.on({columnshow:p.onLockedHeaderShow,columnhide:p.onLockedHeaderHide,columnmove:p.onLockedHeaderMove,sortchange:p.onLockedHeaderSortChange,columnresize:p.onLockedHeaderResize,scope:p});h.on({columnmove:p.onNormalHeaderMove,sortchange:p.onNormalHeaderSortChange,scope:p});p.modifyHeaderCt();p.items=[p.lockedGrid,p.normalGrid];p.relayHeaderCtEvents(b);p.relayHeaderCtEvents(h);p.layout={type:"hbox",align:"stretch"}},processColumns:function(f){var e=0,a=f.length,b=0,d=[],c=[],g;for(;e<a;++e){g=f[e];if(!g.isComponent){g=Ext.apply({},f[e])}g.processed=true;if(g.locked){if(g.flex){Ext.Error.raise("Columns which are locked do NOT support a flex width. You must set a width on the "+f[e].text+"column.")}if(!g.hidden){b+=g.width||Ext.grid.header.Container.prototype.defaultWidth}d.push(g)}else{c.push(g)}if(!g.headerId){g.headerId=(g.initialConfig||g).id||("L"+(++this.headerCounter))}}return{lockedWidth:b,locked:{items:d,itemId:"lockedHeaderCt",stretchMaxPartner:"^^>>#normalHeaderCt"},normal:{items:c,itemId:"normalHeaderCt",stretchMaxPartner:"^^>>#lockedHeaderCt"}}},onLockedViewMouseWheel:function(h){var d=this,g=-d.scrollDelta,a=g*h.getWheelDeltas().y,b=d.lockedGrid.getView().el.dom,c,f;if(b){c=b.scrollTop!==b.scrollHeight-b.clientHeight;f=b.scrollTop!==0}if((a<0&&f)||(a>0&&c)){h.stopEvent();d.scrolling=true;b.scrollTop+=a;d.normalGrid.getView().el.dom.scrollTop=b.scrollTop;d.scrolling=false;d.onNormalViewScroll()}},onLockedViewScroll:function(){var e=this,d=e.lockedGrid.getView(),c=e.normalGrid.getView(),a,b;if(!e.scrolling){e.scrolling=true;c.el.dom.scrollTop=d.el.dom.scrollTop;if(e.store.buffered){b=d.el.child("table",true);a=c.el.child("table",true);b.style.position="absolute"}e.scrolling=false}},onNormalViewScroll:function(){var e=this,d=e.lockedGrid.getView(),c=e.normalGrid.getView(),a,b;if(!e.scrolling){e.scrolling=true;d.el.dom.scrollTop=c.el.dom.scrollTop;if(e.store.buffered){b=d.el.child("table",true);a=c.el.child("table",true);b.style.position="absolute";b.style.top=a.style.top}e.scrolling=false}},onLockedHeaderMove:function(){if(this.syncRowHeight){this.onNormalViewRefresh()}},onNormalHeaderMove:function(){if(this.syncRowHeight){this.onLockedViewRefresh()}},updateSpacer:function(){var d=this,b=d.lockedGrid.getView().el,c=d.normalGrid.getView().el.dom,a=b.dom.id+"-spacer",e=(c.offsetHeight-c.clientHeight)+"px";d.spacerEl=Ext.getDom(a);if(d.spacerEl){d.spacerEl.style.height=e}else{Ext.core.DomHelper.append(b,{id:a,style:"height: "+e})}},onLockedViewRefresh:function(){if(this.normalGrid.headerCt.getGridColumns().length){var e=this,a=e.lockedGrid.getView(),c=a.el,f=c.query(a.getItemSelector()),d=f.length,b=0;e.lockedHeights=[];for(;b<d;b++){e.lockedHeights[b]=f[b].clientHeight}e.syncRowHeights()}},onNormalViewRefresh:function(){if(this.lockedGrid.headerCt.getGridColumns().length){var e=this,a=e.normalGrid.getView(),c=a.el,f=c.query(a.getItemSelector()),d=f.length,b=0;e.normalHeights=[];for(;b<d;b++){e.normalHeights[b]=f[b].clientHeight}e.syncRowHeights();e.updateSpacer()}},onLockedViewItemUpdate:function(a,b,c){if(this.normalGrid.headerCt.getGridColumns().length){this.lockedHeights[b]=c.clientHeight;this.syncRowHeights()}},onNormalViewItemUpdate:function(a,b,c){if(this.lockedGrid.headerCt.getGridColumns().length){this.normalHeights[b]=c.clientHeight;this.syncRowHeights()}},syncRowHeights:function(){var j=this,b=j.lockedHeights,k=j.normalHeights,a=[],h=b.length,f=0,l,d,e,g,c;if(b.length&&k.length){l=j.lockedGrid.getView();d=j.normalGrid.getView();e=l.el.query(l.getItemSelector());g=d.el.query(d.getItemSelector());for(;f<h;f++){if(!isNaN(b[f])&&!isNaN(k[f])){if(b[f]>k[f]){Ext.fly(g[f]).setHeight(b[f])}else{if(b[f]<k[f]){Ext.fly(e[f]).setHeight(k[f])}}}}c=d.el.dom.scrollTop;d.el.dom.scrollTop=c;l.el.dom.scrollTop=c;j.lockedHeights=[];j.normalHeights=[]}},modifyHeaderCt:function(){var a=this;a.lockedGrid.headerCt.getMenuItems=a.getMenuItems(true);a.normalGrid.headerCt.getMenuItems=a.getMenuItems(false)},onUnlockMenuClick:function(){this.unlock()},onLockMenuClick:function(){this.lock()},getMenuItems:function(b){var f=this,g=f.unlockText,h=f.lockText,c=Ext.baseCSSPrefix+"hmenu-unlock",e=Ext.baseCSSPrefix+"hmenu-lock",a=Ext.Function.bind(f.onUnlockMenuClick,f),d=Ext.Function.bind(f.onLockMenuClick,f);return function(){var i=Ext.grid.header.Container.prototype.getMenuItems.call(this);i.push("-",{cls:c,text:g,handler:a,disabled:!b});i.push({cls:e,text:h,handler:d,disabled:b});return i}},lock:function(a,d){var c=this,e=c.normalGrid,g=c.lockedGrid,f=e.headerCt,b=g.headerCt;a=a||f.getMenu().activeHeader;if(a.flex){a.width=a.getWidth();delete a.flex}Ext.suspendLayouts();f.remove(a,false);a.locked=true;if(Ext.isDefined(d)){b.insert(d,a)}else{b.add(a)}c.syncLockedSection();Ext.resumeLayouts(true);c.updateSpacer();c.fireEvent("lockcolumn",c,a)},syncLockedSection:function(){var a=this;a.syncLockedWidth();a.lockedGrid.getView().refresh();a.normalGrid.getView().refresh()},syncLockedWidth:function(){var c=this,a=c.lockedGrid,b=a.headerCt.getFullWidth(true);Ext.suspendLayouts();if(b>0){a.setWidth(b);a.show()}else{a.hide()}Ext.resumeLayouts(true);return b>0},onLockedHeaderResize:function(){this.syncLockedWidth()},onLockedHeaderHide:function(){this.syncLockedWidth()},onLockedHeaderShow:function(){this.syncLockedWidth()},onLockedHeaderSortChange:function(b,c,a){if(a){this.normalGrid.headerCt.clearOtherSortStates(null,true)}},onNormalHeaderSortChange:function(b,c,a){if(a){this.lockedGrid.headerCt.clearOtherSortStates(null,true)}},unlock:function(a,e){var d=this,f=d.normalGrid,h=d.lockedGrid,g=f.headerCt,c=h.headerCt,b=false;if(!Ext.isDefined(e)){e=0}a=a||c.getMenu().activeHeader;Ext.suspendLayouts();c.remove(a,false);if(d.syncLockedWidth()){b=true}a.locked=false;g.insert(e,a);d.normalGrid.getView().refresh();if(b){d.lockedGrid.getView().refresh()}Ext.resumeLayouts(true);d.fireEvent("unlockcolumn",d,a)},applyColumnsState:function(g){var o=this,e=o.lockedGrid,f=e.headerCt,m=o.normalGrid.headerCt,p=Ext.Array.toMap(f.items,"headerId"),h=Ext.Array.toMap(m.items,"headerId"),l=[],n=[],k=1,b=g.length,j,a,d,c;for(j=0;j<b;j++){c=g[j];d=p[c.id];a=d||h[c.id];if(a){if(a.applyColumnState){a.applyColumnState(c)}if(a.locked===undefined){a.locked=!!d}if(a.locked){l.push(a);if(!a.hidden&&typeof a.width=="number"){k+=a.width}}else{n.push(a)}}}if(l.length+n.length==f.items.getCount()+m.items.getCount()){f.removeAll(false);m.removeAll(false);f.add(l);m.add(n);e.setWidth(k)}},getColumnsState:function(){var b=this,a=b.lockedGrid.headerCt.getColumnsState(),c=b.normalGrid.headerCt.getColumnsState();return a.concat(c)},reconfigureLockable:function(a,b){var c=this,e=c.lockedGrid,d=c.normalGrid;if(b){Ext.suspendLayouts();e.headerCt.removeAll();d.headerCt.removeAll();b=c.processColumns(b);e.setWidth(b.lockedWidth);e.headerCt.add(b.locked.items);d.headerCt.add(b.normal.items);Ext.resumeLayouts(true)}if(a){a=Ext.data.StoreManager.lookup(a);c.store=a;e.bindStore(a);d.bindStore(a)}else{e.getView().refresh();d.getView().refresh()}}},function(){this.borrow(Ext.view.Table,["prepareFeatures"])});