Ext.define("Ext.grid.feature.Grouping",{extend:"Ext.grid.feature.Feature",alias:"feature.grouping",eventPrefix:"group",eventSelector:"."+Ext.baseCSSPrefix+"grid-group-hd",bodySelector:"."+Ext.baseCSSPrefix+"grid-group-body",constructor:function(){var a=this;a.collapsedState={};a.callParent(arguments)},groupHeaderTpl:"{columnName}: {name}",depthToIndent:17,collapsedCls:Ext.baseCSSPrefix+"grid-group-collapsed",hdCollapsedCls:Ext.baseCSSPrefix+"grid-group-hd-collapsed",groupByText:"Group By This Field",showGroupsText:"Show in Groups",hideGroupedHeader:false,startCollapsed:false,enableGroupingMenu:true,enableNoGroups:true,enable:function(){var c=this,a=c.view,b=a.store,d;c.lastGroupField=c.getGroupField();if(c.lastGroupIndex){b.group(c.lastGroupIndex)}c.callParent();d=c.view.headerCt.getMenu().down("#groupToggleMenuItem");d.setChecked(true,true);c.refreshIf()},disable:function(){var d=this,a=d.view,b=a.store,f=b.remoteGroup,e,c;c=b.groupers.first();if(c){d.lastGroupIndex=c.property;d.block();b.clearGrouping();d.unblock()}d.callParent();e=d.view.headerCt.getMenu().down("#groupToggleMenuItem");e.setChecked(true,true);e.setChecked(false,true);if(!f){a.refresh()}},refreshIf:function(){if(this.blockRefresh!==true){if(this.grid.ownerCt&&this.grid.ownerCt.lockable){this.grid.ownerCt.view.refresh()}else{this.view.refresh()}}},getFeatureTpl:function(b,c,a,e){var d=this;return["<tpl if=\"typeof rows !== 'undefined'\">",'<tr id="{groupHeaderId}" class="'+Ext.baseCSSPrefix+"grid-group-hd "+(d.startCollapsed?d.hdCollapsedCls:"")+' {hdCollapsedCls}"><td class="'+Ext.baseCSSPrefix+'grid-cell" colspan="'+c.columns.length+'" {[this.indentByDepth(values)]}><div class="'+Ext.baseCSSPrefix+'grid-cell-inner"><div class="'+Ext.baseCSSPrefix+'grid-group-title">{collapsed}{[this.renderGroupHeaderTpl(values)]}</div></div></td></tr>','<tr id="{groupBodyId}" class="'+Ext.baseCSSPrefix+"grid-group-body "+(d.startCollapsed?d.collapsedCls:"")+' {collapsedCls}"><td colspan="'+c.columns.length+'">{[this.recurse(values)]}</td></tr>',"</tpl>"].join("")},getFragmentTpl:function(){var a=this;return{indentByDepth:a.indentByDepth,depthToIndent:a.depthToIndent,renderGroupHeaderTpl:function(b){return Ext.XTemplate.getTpl(a,"groupHeaderTpl").apply(b)}}},indentByDepth:function(a){return'style="padding-left:'+((a.depth||0)*this.depthToIndent)+'px;"'},destroy:function(){delete this.view;delete this.prunedHeader},attachEvents:function(){var b=this,a=b.view;a.on({scope:b,groupclick:b.onGroupClick,rowfocus:b.onRowFocus});a.mon(a.store,{scope:b,groupchange:b.onGroupChange,remove:b.onRemove,add:b.onAdd,update:b.onUpdate});if(b.enableGroupingMenu){b.injectGroupingMenu()}b.pruneGroupedHeader();b.lastGroupField=b.getGroupField();b.block();b.onGroupChange();b.unblock()},onAdd:function(k,c){var h=this,j=h.view,a=h.getGroupField(),f=0,g=c.length,m,d,b,e,l;if(j.rendered){d={};m={};for(;f<g;++f){l=c[f].get(a);if(d[l]===undefined){d[l]=0}d[l]+=1}b=k.getGroups();for(f=0,g=b.length;f<g;++f){l=b[f];m[l.name]=l.children.length}for(l in d){if(d[l]===m[l]){e=true;break}}if(e){j.refresh()}}},onUpdate:function(c,b,d,e){var a=this.view;if(a.rendered&&!e||Ext.Array.contains(e,this.getGroupField())){a.refresh()}},onRemove:function(d,c){var e=this,b=e.getGroupField(),f=c.get(b),a=e.view;if(a.rendered){if(d.findExact(b,f)===-1){e.view.refresh()}}},injectGroupingMenu:function(){var b=this,a=b.view,c=a.headerCt;c.showMenuBy=b.showMenuBy;c.getMenuItems=b.getMenuItems()},showMenuBy:function(b,e){var d=this.getMenu(),c=d.down("#groupMenuItem"),a=e.groupable===false?"disable":"enable";c[a]();Ext.grid.header.Container.prototype.showMenuBy.apply(this,arguments)},getMenuItems:function(){var e=this,b=e.groupByText,d=e.disabled||!e.getGroupField(),a=e.showGroupsText,c=e.enableNoGroups,g=Ext.Function.bind(e.onGroupMenuItemClick,e),f=Ext.Function.bind(e.onGroupToggleMenuItemClick,e);return function(){var h=Ext.grid.header.Container.prototype.getMenuItems.call(this);h.push("-",{iconCls:Ext.baseCSSPrefix+"group-by-icon",itemId:"groupMenuItem",text:b,handler:g});if(c){h.push({itemId:"groupToggleMenuItem",text:a,checked:!d,checkHandler:f})}return h}},onGroupMenuItemClick:function(c,g){var d=this,h=c.parentMenu,i=h.activeHeader,a=d.view,b=a.store,f=b.remoteGroup;delete d.lastGroupIndex;d.block();d.enable();b.group(i.dataIndex);d.pruneGroupedHeader();d.unblock();if(!f){a.refresh()}},block:function(){this.blockRefresh=this.view.blockRefresh=true},unblock:function(){this.blockRefresh=this.view.blockRefresh=false},onGroupToggleMenuItemClick:function(a,b){this[b?"enable":"disable"]()},pruneGroupedHeader:function(){var a=this,b=a.getGroupedHeader();if(a.hideGroupedHeader&&b){if(a.prunedHeader){a.prunedHeader.show()}a.prunedHeader=b;b.hide()}},getGroupedHeader:function(){var a=this.getGroupField(),b=this.view.headerCt;return a?b.down("[dataIndex="+a+"]"):null},getGroupField:function(){var a=this.view.store.groupers.first();if(a){return a.property}return""},onRowFocus:function(c){var b=this.view.getNode(c),a=Ext.fly(b).up("."+this.collapsedCls);if(a){this.expand(a)}},expand:function(f,e){var c=this,a=c.view,d,b=c.lockingPartner;if(Ext.isString(f)){d=Ext.fly(c.getGroupBodyId(f),"_grouping")}else{d=Ext.fly(f,"_grouping");f=c.getGroupName(d)}if(c.collapsedState[f]){d.removeCls(c.collapsedCls);d.prev().removeCls(c.hdCollapsedCls);if(e!==true){a.refreshSize()}a.fireEvent("groupexpand");c.collapsedState[f]=false;if(b){b.expand(f,e)}}},expandAll:function(){var d=this,b=d.view,c=b.el.select(d.eventSelector).elements,f,a=c.length;for(f=0;f<a;f++){d.expand(Ext.fly(c[f]).next(),true)}b.refreshSize()},collapse:function(f,e){var c=this,a=c.view,d,b=c.lockingPartner;if(Ext.isString(f)){d=Ext.fly(c.getGroupBodyId(f),"_grouping")}else{d=Ext.fly(f,"_grouping");f=c.getGroupName(d)}if(!c.collapsedState[f]){d.addCls(c.collapsedCls);d.prev().addCls(c.hdCollapsedCls);if(e!==true){a.refreshSize()}a.fireEvent("groupcollapse");c.collapsedState[f]=true;if(b){b.collapse(f,e)}}},collapseAll:function(){var d=this,b=d.view,c=b.el.select(d.eventSelector).elements,f,a=c.length;for(f=0;f<a;f++){d.collapse(Ext.fly(c[f]).next(),true)}b.refreshSize()},onGroupChange:function(){var d=this,e=d.getGroupField(),c,a,b;if(d.hideGroupedHeader){if(d.lastGroupField){c=d.getMenuItem(d.lastGroupField);if(c){c.setChecked(true)}}if(e){a=d.view.headerCt.getVisibleGridColumns();b=((a.length===1)&&(a[0].dataIndex==e));c=d.getMenuItem(e);if(c&&!b){c.setChecked(false)}}}if(d.blockRefresh!==true){d.view.refresh()}d.lastGroupField=e},getMenuItem:function(b){var a=this.view,d=a.headerCt.down("gridcolumn[dataIndex="+b+"]"),c=a.headerCt.getMenu();return d?c.down("menuitem[headerId="+d.id+"]"):null},onGroupClick:function(a,c,f,d){var b=this;if(b.collapsedState[f]){b.expand(f)}else{b.collapse(f)}},getMetaRowTplFragments:function(){return{isRow:this.isRow,closeRow:this.closeRow}},isRow:function(){return"<tpl if=\"typeof rows === 'undefined'\">"},closeRow:function(){return"</tpl>"},mutateMetaRowTpl:function(a){a.unshift("{[this.isRow()]}");a.push("{[this.closeRow()]}")},getAdditionalData:function(e,i,f,h){var g=this.view,d=g.headerCt,c=d.items.getAt(0),b={},a;if(c){a=c.id+"-tdAttr";b[a]=this.indentByDepth(e)+" "+(h[a]?h[a]:"");b.collapsed="true";b.data=f.getData()}return b},getGroupRows:function(l,d,m,j){var h=this,c=l.children,n=l.rows=[],i=h.view,f=h.getGroupedHeader(),b=h.getGroupField(),g=-1,a,k=d.length,e;l.viewId=i.id;for(a=0;a<k;a++){e=d[a];if(e.get(b)==l.name){g=a}if(Ext.Array.indexOf(c,e)!=-1){n.push(Ext.apply(m[a],{depth:1}))}}l.groupHeaderId=h.getGroupHeaderId(l.name);l.groupBodyId=h.getGroupBodyId(l.name);l.fullWidth=j;l.columnName=f?f.text:b;l.groupValue=l.name;if(f&&g>-1){l.name=l.renderedValue=m[g][f.id]}if(h.collapsedState[l.name]){l.collapsedCls=h.collapsedCls;l.hdCollapsedCls=h.hdCollapsedCls}return l},getGroupHeaderId:function(a){return this.view.id+"-hd-"+a},getGroupBodyId:function(a){return this.view.id+"-bd-"+a},getGroupName:function(a){var b=this,c;c=Ext.fly(a).findParent(b.eventSelector);if(c){return c.id.split(this.view.id+"-hd-")[1]}c=Ext.fly(a).findParent(b.bodySelector);if(c){return c.id.split(this.view.id+"-bd-")[1]}},collectData:function(c,l,k,h,a){var e=this,i=e.view.store,d,b,f,j;if(!e.disabled&&i.isGrouped()){b=i.getGroups();f=b.length;for(d=0;d<f;d++){j=b[d];e.getGroupRows(j,c,l,h)}return{rows:b,fullWidth:h}}return a},getFireEventArgs:function(b,a,d,c){return[b,a,d,this.getGroupName(d),c]}});